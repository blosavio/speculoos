<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>speculoos.function-specs documentation</title><link rel="stylesheet" type="text/css" href="default.css" /><link rel="stylesheet" type="text/css" href="highlight.css" /><script type="text/javascript" src="highlight.min.js"></script><script type="text/javascript" src="jquery.min.js"></script><script type="text/javascript" src="page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Speculoos</span> <span class="project-version">version 5</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1"><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>speculoos</span></div></div></li><li class="depth-2 branch"><a href="speculoos.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch current"><a href="speculoos.function-specs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>function-specs</span></div></a></li><li class="depth-2"><a href="speculoos.utility.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>utility</span></div></a></li></ul><ul class="index-link"><li class="depth-1"><a href="https://github.com/blosavio/speculoos">Project Home</a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="speculoos.function-specs.html#var-assoc-metadata-f.21"><div class="inner"><span>assoc-metadata-f!</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-dissoc-metadata-f.21"><div class="inner"><span>dissoc-metadata-f!</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-exercise-fn"><div class="inner"><span>exercise-fn</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-inject-specs.21"><div class="inner"><span>inject-specs!</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-instrument"><div class="inner"><span>instrument</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-recognized-spec-keys"><div class="inner"><span>recognized-spec-keys</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-unject-specs.21"><div class="inner"><span>unject-specs!</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-unstrument"><div class="inner"><span>unstrument</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-validate-argument-return-relationship"><div class="inner"><span>validate-argument-return-relationship</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-validate-fn"><div class="inner"><span>validate-fn</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-validate-fn-with"><div class="inner"><span>validate-fn-with</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-validate-higher-order-fn"><div class="inner"><span>validate-higher-order-fn</span></div></a></li><li class="depth-1"><a href="speculoos.function-specs.html#var-wrapping-fn"><div class="inner"><span>wrapping-fn</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">speculoos.function-specs</h1><div class="doc"><div class="markdown"><p>This namespace provides facilities to apply specifications to and validate functions. Roughly speaking, trying to replicate the instrumentation and testing capabilities of <a href="https://clojure.org/guides/spec#_instrumentation_and_testing">spec.alpha</a> .</p>
<p>Speculoos explores a few different <em>styles</em> of function specification:</p>
<ol>
<li>Explicitly providing the specification during explicit validation.</li>
<li>Implicitly providing the specification via metadata, explicitly validating.</li>
<li>Implicitly providing the specification via metadata, implicitly validating via instrumentation.</li>
</ol>
<p><strong>Warning</strong>: Several actions performed by functions in this namespace mutate state, and are brittle. Use this namespace with the understanding that it is very much a proof-of-concept.</p>
</div></div><div class="public anchor" id="var-assoc-metadata-f.21"><h3>assoc-metadata-f!</h3><div class="usage"><code>(assoc-metadata-f! f k v)</code></div><div class="doc"><div class="markdown"><p>Associate metadata key <code>k</code>, value <code>v</code> to the var of function <code>f</code>. Returns the metadata map. See <a href="speculoos.function-specs.html#var-dissoc-metadata-f.21">dissoc-metadata-f!</a> for the inverse operation.</p>
<p>Example:</p>
<pre><code class="language-clojure">(defn foo [] true)

(assoc-metadata-f! foo :assoced 'bar!)

(:assoced (meta #'foo)) ;; =&gt; 'bar!
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L67">view source</a></div></div><div class="public anchor" id="var-dissoc-metadata-f.21"><h3>dissoc-metadata-f!</h3><div class="usage"><code>(dissoc-metadata-f! f k)</code></div><div class="doc"><div class="markdown"><p>Dissociate metadata key <code>k</code> from the var of function <code>f</code>. Returns the metadata map. See <a href="speculoos.function-specs.html#var-assoc-metadata-f.21">assoc-metadata-f!</a> for the inverse operation.</p>
<p>Example:</p>
<pre><code class="language-clojure">(defn foo [] true)

(assoc-metadata-f! foo :assoced 'bar!)

(:assoced (meta #'foo)) ;; =&gt; 'bar!

(dissoc-metadata-f! foo :assoced)

(:assoced (meta #'foo)) ;; =&gt; nil
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L85">view source</a></div></div><div class="public anchor" id="var-exercise-fn"><h3>exercise-fn</h3><div class="usage"><code>(exercise-fn f)</code><code>(exercise-fn f n)</code></div><div class="doc"><div class="markdown"><p>Exercises the function <code>f</code> by applying it to <code>n</code> (default <code>10</code>) generated samples of its scalar argument specification, residing at <code>:speculoos/arg-scalar-spec</code> in its metadata.</p>
<p>Returns a sequence of tuples of <code>[args ret]</code>. Does not currently handle higher-order-functions.</p>
<p>If <code>n</code> is <code>:canonical</code>, only one data set is produced, consisting of the predicates’ canonical values.</p>
<p>See <a href="speculoos.utility.html#var-data-from-spec">data-from-spec</a> for details on predicates.</p>
<p>Example:</p>
<pre><code class="language-clojure">(defn foo [x kw] (str (+ 100 x) "is not equivalent to " kw))

(foo 5 :bar) ;; "105 is not equivalent to :bar"

(inject-specs! foo {:speculoos/arg-scalar-spec [int? keyword?]})

(exercise-fn foo 3)
;; =&gt; ([[76 :i-:!7S] "176 is not equivalent to :i-:!7S"]
;;     [[-381 :W] "-281 is not equivalent to :W"]
;;     [[-940 :LS1-:i] "-840 is not equivalent to :LS1-:i"])
</code></pre>
<p>Examples with canonical values:</p>
<pre><code class="language-clojure">(defn bar
  {:speculoos/arg-scalar-spec [int? ratio? float?]}
  [x y z]
  (+ x y z))

(exercise-fn bar :canonical)
;; =&gt; ([[42 22/7 1.23] 46.372857142857136])
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L656">view source</a></div></div><div class="public anchor" id="var-inject-specs.21"><h3>inject-specs!</h3><div class="usage"><code>(inject-specs! f specs)</code></div><div class="doc"><div class="markdown"><p>Given function <code>f</code>, associates scalar and collection specifications for arguments and return values. <code>specs</code> is a map, whose only recognized pseudo-qualified keys are contained in <a href="speculoos.function-specs.html#var-recognized-spec-keys">recognized-spec-keys</a>. No warnings are given for key-vals that are not recognized and thus not injected. Returns <code>nil</code>. See <a href="speculoos.function-specs.html#var-unject-specs.21">unject-specs!</a> for the inverse operation.</p>
<p>Example:</p>
<pre><code class="language-clojure">(defn foo [] true)

(inject-specs! foo {:speculoos/ret-scalar-spec boolean?}) ;; =&gt; nil

(:speculoos/ret-scalar-spec (meta #'foo)) ;; =&gt; boolean?
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L123">view source</a></div></div><div class="public anchor" id="var-instrument"><h3>instrument</h3><div class="usage"><code>(instrument f)</code></div><div class="doc"><div class="markdown"><p><em>Wrap</em> function <code>f</code> such that invoking <code>f</code> implicitly performs argument validation before and return value validation after execution. See <a href="speculoos.function-specs.html#var-wrapping-fn">wrapping-fn</a> for details.</p>
<p>Implemented by:</p>
<ol>
<li>Adding an entry into the instrumentation registry.</li>
<li>Altering <code>f</code>’s root var to wrapped version of itself.</li>
</ol>
<p>The inverse operation is provided by <a href="speculoos.function-specs.html#var-unstrument">unstrument</a>.</p>
<p><strong>Warning:</strong> This implementation is experimental and brittle. Since it relies on mutating vars, it is sensitive to order of invocation and multiple invocations.</p>
<p>Examples:</p>
<pre><code class="language-clojure">(defn add-n-subtract [x y] [(+ x y) (- x y)])

;; `instrument` requires specifications be added *before* instrumentation
(inject-specs! add-n-subtract {:speculoos/arg-scalar-spec [int? ratio?]})

(instrument add-n-subtract)

;; while instrumented, each invocation automatically validates any supplied specification
;; non-satisfied predicates are send to *out*
(with-out-str (add-n-subtract 5 2)) ;; printed to *out* ({:path [1], :datum 2, :predicate ratio?, :valid? false})

;; if all specifications are satisfied, the function returns a value
(add-n-subtract 5 3/2) ;; =&gt; [13/2 7/2]

;; remove instrumentation wrapper...
(unstrument add-n-subtract) ;; =&gt; {}

;; ...but metadata specifications remain
(:speculoos/arg-scalar-spec (meta #'add-n-subtract)) ;; =&gt; [int? ratio?]

;; function resumes normal behavior; non-satisfying arguments are consumed without note
(add-n-subtract 5 2) ;; =&gt; [7 3]
(add-n-subtract 5 3/2) ;; =&gt; [13/2 7/2]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L579">view source</a></div></div><div class="public anchor" id="var-recognized-spec-keys"><h3>recognized-spec-keys</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>A sequence that contains the only allowed pseudo-qualified keys to be added to, or referred from, a function’s metadata. Only governs behavior of utilities provided by this namespace, such as <a href="speculoos.function-specs.html#var-instrument">instrument</a>, <a href="speculoos.function-specs.html#var-unstrument">unstrument</a>, <a href="speculoos.function-specs.html#var-validate-fn-with">validate-fn-with</a>, and <a href="speculoos.function-specs.html#var-validate-fn">validate-fn</a>. Does not affect anything outside this namespace.</p>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L107">view source</a></div></div><div class="public anchor" id="var-unject-specs.21"><h3>unject-specs!</h3><div class="usage"><code>(unject-specs! f)</code></div><div class="doc"><div class="markdown"><p>Given function <code>f</code>, dissociates any key-vals contained in <a href="speculoos.function-specs.html#var-recognized-spec-keys">recognized-spec-keys</a>. Inverse operation provided by <a href="speculoos.function-specs.html#var-inject-specs.21">inject-specs!</a>. Returns <code>nil</code>.</p>
<p>Example:</p>
<pre><code class="language-clojure">(defn foo [] true)

(inject-specs! foo {:speculoos/ret-scalar-spec boolean?}) ;; =&gt; nil

(:speculoos/ret-scalar-spec (meta #'foo)) ;; =&gt; boolean?

(unject-specs! foo) ;; =&gt; nil

(:speculoos/ret-scalar-spec (meta #'foo)) ;; =&gt; nil
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L145">view source</a></div></div><div class="public anchor" id="var-unstrument"><h3>unstrument</h3><h4 class="type">macro</h4><div class="usage"><code>(unstrument f)</code></div><div class="doc"><div class="markdown"><p><em>Un-wrap</em> function <code>f</code> to its original form that does not implicitly validate arguments nor return values.pre-fn nor post-fn. This is the inverse operation of <a href="speculoos.function-specs.html#var-instrument">instrument</a>.</p>
<p>Compliments to whoever originally thought of ‘unstrument’.</p>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L644">view source</a></div></div><div class="public anchor" id="var-validate-argument-return-relationship"><h3>validate-argument-return-relationship</h3><div class="usage"><code>(validate-argument-return-relationship arg ret rel)</code></div><div class="doc"><div class="markdown"><p>Validates an argument/return relationship given argument sequence <code>arg</code>, function return value <code>ret</code>, and relationship <code>rel</code>, a map of <code>{:path-argument … :path-return … :relationship-fn …}</code>. <code>:relationship-fn</code> is a 2-arity function that presumably tests some relationship between a slice of <code>arg</code>, passed as the first argument to the relationship function, and a slice of <code>ret</code>, passed as the second argument to the relationship function. A <code>nil</code> path indicates a ‘bare’ scalar value (i.e., a non-collection). <code>arg</code> ought to always be a sequence.</p>
<p>Intended to validate the relationship between a function’s arguments and its return value.</p>
<p>Examples:</p>
<pre><code class="language-clojure">(defn doubled? [x y] (= y (* 2 x)))

;; 'bare' function return, uses path `nil`
(validate-argument-return-relationship [42] 84 {:path-argument [0]
                                                :path-return nil
                                                :relationship-fn doubled?})
;; =&gt; {:path-argument [0],
;;     :path-return nil,
;;     :relationship-fn doubled?,
;;     :datum-argument 42,
;;     :datum-return 84,
;;     :valid? true}


(defn reversed? [v1 v2] (= v2 (reverse v1)))

;; argument and return value fail to satisfy relationship
(validate-argument-return-relationship [1 2 3] [1 2 3] {:path-argument []
                                                        :path-return []
                                                        :relationship-fn reversed?})
;; =&gt; {:path-argument [],
;;     :path-return [],
;;     :relationship-fn reversed?,
;;     :datum-argument [1 2 3],
;;     :datum-return [1 2 3],
;;     :valid? false}
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L181">view source</a></div></div><div class="public anchor" id="var-validate-fn"><h3>validate-fn</h3><div class="usage"><code>(validate-fn f &amp; args)</code></div><div class="doc"><div class="markdown"><p>Validates function <code>f</code> in the manner of <a href="speculoos.function-specs.html#var-validate-fn-with">validate-fn-with</a>, except specifications are supplied by the function’s metadata, addressed by <a href="speculoos.function-specs.html#var-recognized-spec-keys">recognized-spec-keys</a>.</p>
<p>Examples:</p>
<pre><code class="language-clojure">(defn foo [x s] (+ x (read-string s)))
(foo 7 "8") ;; 15

(def foo-spec {:speculoos/arg-scalar-spec [int? string?]
               :speculoos/ret-scalar-spec number?})

(inject-specs! foo foo-spec) ;; =&gt; nil

;; supplying valid arguments; function returns
(validate-fn foo 7 "8") ;; 15

;; supplying invalid argument (arg2 is not a string); yields a report
(validate-fn foo 7 8)
;; =&gt; ({:path [1], :datum 8, :predicate string?, :valid? false, :fn-spec-type :speculoos/argument}
;; foo was not able to yield a value, therefore the return was not validated
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L344">view source</a></div></div><div class="public anchor" id="var-validate-fn-with"><h3>validate-fn-with</h3><div class="usage"><code>(validate-fn-with f specs &amp; args)</code></div><div class="doc"><div class="markdown"><p>Validate the scalar and collection aspects of arguments <code>args</code>, the return value, and the relationship between the arguments and return value, of function <code>f</code>. <code>specs</code> is a map with any permutation of <a href="speculoos.function-specs.html#var-recognized-spec-keys">recognized-spec-keys</a>. Returns <code>f</code>’s results if <code>specs</code> are fully satisfied, otherwise, returns a report.</p>
<p>Note: Argument and return values satisfying the specifications does not guarantee that the function’s output is correct.</p>
<p>See <a href="speculoos.core.html#var-validate-scalars">validate-scalars</a> and <a href="speculoos.core.html#var-validate-collections">validate-collections</a> for details about scalar and collection validation.</p>
<p>See <a href="speculoos.function-specs.html#var-validate-argument-return-relationship">validate-argument-return-relationship</a> for details about validating relationships between the function’s argument and the function’s return value.</p>
<p>Example, validating scalars:</p>
<pre><code class="language-clojure">(defn foo [x y] (+ x y))

;; no specifications; return value passes through
(validate-fn-with foo {} 2 3)
;; =&gt; 5

;; all scalar specifications satisfied; return value passes through
(validate-fn-with foo
                  {:speculoos/arg-scalar-spec [int? int?]
                   :speculoos/ret-scalar-spec int?}
                  2 3)
;; =&gt; 5

;; one argument scalar specification and the return value scalar specification not satisfied
(validate-fn-with foo
                  {:speculoos/arg-scalar-spec [int? int?]
                   :speculoos/ret-scalar-spec int?}
                  2 3.3)
;; =&gt; ({:path [1], :datum 3.3, :predicate int?, :valid? false, :fn-spec-type :speculoos/argument}
;;     {:path nil, :datum 5.3, :predicate int?, :valid? false, :fn-spec-type :speculoos/return})
</code></pre>
<p>Example, validating argument/return value relationship:</p>
<pre><code class="language-clojure">;; function to validate
(defn broken-reverse [v] v)

;; function to test if the return collection is a correctly reversed version of the argument collection
(defn reversed? [v1 v2] (= v2 (reverse v1)))

;; yup, it's truly broken
(reversed? [11 22 33] (broken-reverse [11 22 33]))
;; =&gt; false

;; `broken-reverse` fails to satisfy the relationship function because it doesn't correctly reverse the argument collection
(validate-fn-with broken-reverse
                  {:speculoos/argument-return-relationships [{:path-argument [0]
                                                              :path-return []
                                                              :relationship-fn reversed?}]}
                  [11 22 33])
;; =&gt; ({:path-argument [0],
;;      :path-return [],
;;      :relationship-fn reversed?,
;;      :datum-argument [11 22 33],
;;      :datum-return [11 22 33],
;;      :valid? false,
;;      :fn-spec-type
;;      :speculoos/argument-return-relationship})
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L235">view source</a></div></div><div class="public anchor" id="var-validate-higher-order-fn"><h3>validate-higher-order-fn</h3><div class="usage"><code>(validate-higher-order-fn f &amp; args)</code></div><div class="doc"><div class="markdown"><p>Evaluates arbitrarily-deep, higher-order function <code>f</code> to exhaustion (i.e., until it yields a value that is not a function), validating arguments <code>args</code> and the return value. Halts on exceptions. Caller must supply sufficient <code>&amp;-arg</code> vectors such that the final output could satisfy the return specification, if it exists.</p>
<p>Specifications are supplied in the top-level function’s metadata. All other lower-level function var metadata is ignored. Specifications must be a member of <a href="speculoos.function-specs.html#var-recognized-spec-keys">recognized-spec-keys</a>. Specifications for the top-level function reside in the standard keys. Specifications for lower-level functions are nested into their respective tiers of the <code>:speculoos/hof-specs</code> key. If an argument collection specification is supplied for a lower-level function, a collection specification must be supplied for all functions ‘above’ that, even if those higher-level specifications are empty.</p>
<p>If every specification is satisfied, then the function’s evaluated value is returned, otherwise a sequence of invalidation reports.</p>
<p>Un-defined behavior if the final yield is <code>nil</code> or a function.</p>
<p>If you would call</p>
<p><code>(((f 1 2) :foo :bar) 'a 'b)</code></p>
<p>then the validation would be</p>
<p><code>(validate-higher-order-fn f [1 2] [:foo :bar] ['a 'b])</code></p>
<p>Use <code>(with-meta f m)</code> for <em>ad hoc</em> specification.</p>
<p>Example:</p>
<pre><code class="language-clojure">(defn foo [x y] (fn [w z] (* (+ x w) (- y z))))

(def bar (foo 8 11))
(bar 12 6) ;; 100

(def foo-spec {:speculoos/arg-scalar-spec [int? ratio?]
               :speculoos/hof-specs {:speculoos/arg-scalar-spec [int? ratio?]}})

(inject-specs! foo foo-spec) ;; nil

;; even though `foo` could consume these arguments and produce a value,
;; the arguments do not satisfy specification
(validate-higher-order-fn foo [8 11] [12 6])
;; =&gt; ({:path [0 1], :datum 11, :predicate ratio?, :valid? false, :fn-tier :speculoos/argument}
;;     {:path [1 1], :datum 6, :predicate ratio?, :valid? false, :fn-tier :speculoos/argument})

;; arguments satisfy specification, so `foo` returns the value
(validate-higher-order-fn foo [8 16/3] [12 1/3]) ;; 100N
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L445">view source</a></div></div><div class="public anchor" id="var-wrapping-fn"><h3>wrapping-fn</h3><div class="usage"><code>(wrapping-fn f)</code></div><div class="doc"><div class="markdown"><p>Low-level plumbing for <a href="speculoos.function-specs.html#var-instrument">instrument</a>. See <a href="speculoos.function-specs.html#var-validate-fn-with">validate-fn-with</a> for details.</p>
<p>Returns a function that will sequentially:</p>
<ol>
<li>Validate arguments with scalar specifications.</li>
<li>Validate argument sequence with collection specification.</li>
<li>Invoke function <code>f</code>.</li>
<li>Validate return value with scalar specification.</li>
<li>Validate return value with collection specification.</li>
<li>Validate arguments versus return specifications.</li>
</ol>
<p>Execution of the returned function will print non-satisfied specs to <code>*out*</code> and return the value produced by invoking <code>f</code> with the supplied arguments. At time of wrapping, function metadata must contain any desired specifications, possibly added by <a href="speculoos.function-specs.html#var-inject-specs.21">inject-specs!</a>. Will not halt on non-valid specs.</p>
<p>Note: Arguments and return value satisfying their specification does not guarantee that the function’s output is correct.</p>
</div></div><div class="src-link"><a href="https://github.com/blosavio/speculoos/blob/main/src/speculoos/function_specs.clj#L544">view source</a></div></div></div></body></html>